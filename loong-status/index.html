<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Package Status</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        /* è®¾ç½®æœ€å¤§å®½åº¦å¹¶å…è®¸æ°´å¹³æ»šåŠ¨ */
        /* Set maximum width and allow horizontal scrolling */
        .table-container {
            max-width: 100%;
            overflow-x: auto;
        }
        td {
            max-width: 150px;  /* è®¾ç½®å•å…ƒæ ¼æœ€å¤§å®½åº¦ */ /* Set maixumum width of a cell */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;  /* è¶…å‡ºå†…å®¹ç”¨çœç•¥å·è¡¨ç¤º */ /* Overflow content omitted */
        }
        .stats {
            margin-bottom: 20px;
            font-size: 16px;
        }
	.status-heading {
            display: inline-block;
            vertical-align: middle;
        }
        .tooltip {
            position: relative;
            vertical-align: middle;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 550px;
            background-color: black;
            color: #fff;
            text-align: left;
            border-radius: 5px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: 20px;
            margin-bottom: 20px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <h1 class="status-heading">Package Status</h1>
    <div class="tooltip">â“
        <div id="comments_zh-CN" class="tooltip-text">
            <p>âœ…: loongVersion å’Œ x86Version ä¸€è‡´ </p>
            <p>âŒ: loongVersionã€loongTestingVersion å’Œ loongStagingVersion éƒ½æ˜¯ 'N/A' </p>
            <p>â˜¯: loongTestingVersion æˆ– loongStagingVersion å’Œ x86Version ä¸€è‡´ </p>
            <p>â­•: ä¸‰è€…éƒ½ä¸ä¸€è‡´ï¼Œä½†æœ‰å€¼ </p>
            <p>ğŸ—‘: x86Version æ˜¯ 'N/A'ï¼Œè€Œ loongVersionã€loongTestingVersion æˆ– loongStagingVersion ä»»æ„ä¸€ä¸ªæœ‰å€¼ </p>
        </div>

        <div id="comments_en-US" class="tooltip-text">
            <p>âœ…: loongVersion and x86Version matches </p>
            <p>âŒ: loongVersion, loongTestingVersion and loongStagingVersion are all 'N/A' </p>
            <p>â˜¯: loongTestingVersion or loongStagingVersion matches x86Version  </p>
            <p>â­•: none of the versions are a match, but not 'N/A' either </p>
            <p>ğŸ—‘: x86Version is 'N/A', but loongVersion, loongTestingVersion or loongStagingVersion is not 'N/A' </p>
        </div>
    </div>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
    <!-- Stats display region -->
    <div id="stats" class="stats">
        <!-- ç»Ÿè®¡ä¿¡æ¯å°†ç”± JavaScript åŠ¨æ€æ’å…¥ -->
         <!-- Stats are inserted via Javascript dynamically -->
    </div>
    <div class="table-container">
        <table id="packageTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Base</th>
                    <th>Repo</th>
                    <th>x86 Version</th>
                    <th>Loong Version</th>
                    <th>Loong Testing Version</th>
                    <th>Loong Staging Version</th>
                    <th>Comparison Result</th> <!-- æ–°å¢ä¸€åˆ— --> <!-- Add an extra column -->
                </tr>
            </thead>
            <tbody>
                <!-- Data will be inserted here dynamically -->
            </tbody>
        </table>
    </div>

    <script>
        // Function to create a new row and append to table
        function createRow(package) {
            const row = document.createElement('tr');

            // Compare versions and determine the symbol to display
            const x86Version = package.x86_version;
            const loongVersion = package.loong_version;
            const loongTestingVersion = package.loong_testing_version;
            const loongStagingVersion = package.loong_staging_version;

            let comparisonResult;

            // å¦‚æœ loongVersionã€loongTestingVersion å’Œ loongStagingVersion éƒ½æ˜¯ 'N/A'ï¼Œæ˜¾ç¤º âŒ
            // if loongVersion,loongTestingVersion and loongStagingVersion are all 'N/A', display âŒ
            if ((!loongVersion || loongVersion === 'N/A') &&
                (!loongTestingVersion || loongTestingVersion === 'N/A') &&
                (!loongStagingVersion || loongStagingVersion === 'N/A')) {
                comparisonResult = 'âŒ';
            }
            // å¦‚æœ loongVersion å’Œ x86Version ä¸€è‡´ï¼Œæ˜¾ç¤º âœ…
            // if loongVersion and x86Version matches, display âœ…
            else if (loongVersion === x86Version) {
                comparisonResult = 'âœ…';
            }
            // å¦‚æœ loongTestingVersion æˆ– loongStagingVersion å’Œ x86Version ä¸€è‡´ï¼Œæ˜¾ç¤º â˜¯
            // if loongTestingVersion or loongStagingVersion matches x86Version, display â˜¯
            else if (loongTestingVersion === x86Version || loongStagingVersion === x86Version) {
                comparisonResult = 'â˜¯';
            }
            // å¦‚æœä¸‰è€…éƒ½ä¸ä¸€è‡´ï¼Œä½†æœ‰å€¼ï¼Œæ˜¾ç¤º â­•
            // if none of the versions are a match, but not 'N/A' either, display â­•
            else {
                comparisonResult = 'â­•';
            }

            row.innerHTML = `
                <td>${package.name || 'N/A'}</td>
                <td>${package.base || 'N/A'}</td>
                <td>${package.repo || 'N/A'}</td>
                <td>${x86Version || 'N/A'}</td>
                <td>${loongVersion || 'N/A'}</td>
                <td>${loongTestingVersion || 'N/A'}</td>
                <td>${loongStagingVersion || 'N/A'}</td>
                <td>${comparisonResult}</td> <!-- æ–°å¢æ¯”è¾ƒç»“æœçš„åˆ— --> <!-- extra column for result comparison -->
            `;

            return { row, comparisonResult };
        }

        // Function to calculate statistics and update the stats section
        function updateStats(data) {
            let coreTotal = 0, extraTotal = 0;
            let coreMatch = 0, corePartialMatch = 0, coreNoMatch = 0, coreDiff = 0, coreDeprecated = 0;
            let extraMatch = 0, extraPartialMatch = 0, extraNoMatch = 0, extraDiff = 0, extraDeprecated = 0;
            data.forEach(package => {
                const x86Version = package.x86_version;
                const loongVersion = package.loong_version;
                const loongTestingVersion = package.loong_testing_version;
                const loongStagingVersion = package.loong_staging_version;
                let comparisonResult;
                // å¦‚æœ x86Version æ˜¯ 'N/A'ï¼Œè€Œ loongVersionã€loongTestingVersion æˆ– loongStagingVersion ä»»æ„ä¸€ä¸ªæœ‰å€¼ï¼Œæ˜¾ç¤º ğŸ—‘
                // if x86Version is 'N/A', but loongVersion, loongTestingVersion or loongStagingVersion is not 'N/A', display ğŸ—‘
                if (x86Version === 'N/A' && (loongVersion || loongTestingVersion || loongStagingVersion)) {
                    comparisonResult = 'ğŸ—‘';
                }
                // å¦‚æœ loongVersionã€loongTestingVersion å’Œ loongStagingVersion éƒ½æ˜¯ 'N/A'ï¼Œæ˜¾ç¤º âŒ
                // if loongVersion,loongTestingVersion and loongStagingVersion are all 'N/A', display âŒ
                else if ((!loongVersion || loongVersion === 'N/A') &&
                    (!loongTestingVersion || loongTestingVersion === 'N/A') &&
                    (!loongStagingVersion || loongStagingVersion === 'N/A')) {
                    comparisonResult = 'âŒ';
                }
                // å¦‚æœ loongVersion å’Œ x86Version ä¸€è‡´ï¼Œæ˜¾ç¤º âœ…
                // if loongVersion and x86Version matches, display âœ…
                else if (compareVersions(loongVersion, x86Version)) {
                    comparisonResult = 'âœ…';
                }
                // å¦‚æœ loongTestingVersion æˆ– loongStagingVersion å’Œ x86Version ä¸€è‡´ï¼Œæ˜¾ç¤º â˜¯
                // if loongTestingVersion or loongStagingVersion matches x86Version, display â˜¯
                else if (compareVersions(loongTestingVersion, x86Version) || compareVersions(loongStagingVersion, x86Version)) {
                    comparisonResult = 'â˜¯';
                }
                // å¦‚æœä¸‰è€…éƒ½ä¸ä¸€è‡´ï¼Œä½†æœ‰å€¼ï¼Œæ˜¾ç¤º â­•
                // if none of the versions are a match, but not 'N/A' either, display â­•
                else {
                    comparisonResult = 'â­•';
                }
                if (package.repo === 'core') {
                    coreTotal++;
                    if (comparisonResult === 'âœ…') {
                        coreMatch++;
                    } else if (comparisonResult === 'â˜¯') {
                        corePartialMatch++;
                    } else if (comparisonResult === 'â­•') {
                        coreDiff++;
                    } else if (comparisonResult === 'ğŸ—‘') {
                        coreDeprecated++;
                    } else {
                        coreNoMatch++;
                    }
                } else if (package.repo === 'extra') {
                    extraTotal++;
                    if (comparisonResult === 'âœ…') {
                        extraMatch++;
                    } else if (comparisonResult === 'â˜¯') {
                        extraPartialMatch++;
                    } else if (comparisonResult === 'â­•') {
                        extraDiff++;
                    } else if (comparisonResult === 'ğŸ—‘') {
                        extraDeprecated++;
                    } else {
                        extraNoMatch++;
                    }
                }
            });
            const coreStats = `${coreMatch + corePartialMatch}/${coreTotal} 
                (âœ…: ${coreMatch}, â˜¯: ${corePartialMatch}, â­•: ${coreDiff}, ğŸ—‘: ${coreDeprecated}, âŒ: ${coreNoMatch})`;
            const extraStats = `${extraMatch + extraPartialMatch}/${extraTotal} 
                (âœ…: ${extraMatch}, â˜¯: ${extraPartialMatch}, â­•: ${extraDiff}, ğŸ—‘: ${extraDeprecated}, âŒ: ${extraNoMatch})`;
            const statsDiv = document.getElementById('stats');
            fetch('/api/lastupdate')
                .then(response => response.json())
                .then(data => {
                    const lastUpdateUTC = data.last_update;
                    const lastUpdateDate = new Date(lastUpdateUTC);
                    const lastUpdateLocal = lastUpdateDate.toLocaleString();
                    statsDiv.innerHTML = `
                        <p><strong>Core Repo:</strong> ${coreStats}</p>
                        <p><strong>Extra Repo:</strong> ${extraStats}</p>
                        <p><strong>Last Update:</strong> ${lastUpdateLocal}</p>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching last update time:', error);
                    statsDiv.innerHTML = `
                        <p><strong>Core Repo:</strong> ${coreStats}</p>
                        <p><strong>Extra Repo:</strong> ${extraStats}</p>
                        <p><strong>Last Update:</strong> N/A</p>
                    `;
                });
        }

        // Helper function to compare versions
        function compareVersions(loongVersion, x86Version) {
            if (!loongVersion || !x86Version) return false;
            const [loongMajor, loongMinor] = loongVersion.split('-')[0].split('.');
            const [x86Major, x86Minor] = x86Version.split('-')[0].split('.');
            return loongMajor === x86Major;
        }

        // Function to fetch data from API and display incrementally
        async function fetchData() {
            try {
                const response = await fetch('/api/packages/status');
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let tableBody = document.querySelector('#packageTable tbody');
                let partialData = ''; // Used to store partial JSON data
                
                let allData = []; // Store all data for stats
                
                // Keep reading data stream until it's done
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break; // Exit when stream is done

                    // Decode the chunk and concatenate with previous partial data
                    partialData += decoder.decode(value, { stream: true });
                    
                    // Attempt to parse JSON array
                    try {
                        const data = JSON.parse(partialData);
                        // Clear table first, in case of previous data
                        tableBody.innerHTML = '';
                        allData = data; // Store data for statistics
                        
                        // Insert each package row by row
                        data.forEach(pkg => {
                            const { row, comparisonResult } = createRow(pkg);
                            tableBody.appendChild(row);
                        });

                        // Update statistics after all data is processed
                        updateStats(data);
                    } catch (e) {
                        // If the partial data is not a complete JSON yet, continue fetching more
                    }
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Fetch data when the page loads
        window.onload = fetchData;

        const userLang = navigator.language || navigator.userLanguage;

        const chineseTooltip = document.getElementById('comments_zh-CN');
        const englishTooltip = document.getElementById('comments_en-US');

        if (userLang.startsWith('zh')) {
            chineseTooltip.style.display = 'block';
            englishTooltip.style.display = 'none';
        } else {
            chineseTooltip.style.display = 'none';
            englishTooltip.style.display = 'block';
        }

        const tooltip = document.querySelector('.tooltip');
        tooltip.addEventListener('mouseenter', () => {
            const activeTooltip = userLang.startsWith('zh') ? chineseTooltip : englishTooltip;
            const tooltipBox = activeTooltip.getBoundingClientRect();
            const windowHeight = window.innerHeight;

            activeTooltip.style.bottom = 'auto';
            activeTooltip.style.top = '125%';
        });
    </script>
</body>
</html>
